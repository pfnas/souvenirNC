<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Album Souvenirs Géré par Firestore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .flip-book-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 50vh; 
            width: 100%;
        }
        #monAlbum { visibility: hidden; }
        
        /* Conteneur de Page principal */
        .page {
            background-color: #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #ccc;
            padding: 1rem;
            overflow: hidden;
            box-sizing: border-box; /* IMPORTANT pour le calcul de la hauteur */
        }
        
        /* Conteneur de Contenu - Doit remplir la page entière */
        .content-page-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            justify-content: space-between; /* Pour pousser la légende en bas */
            align-items: center;
            text-align: center;
            box-sizing: border-box;
        }

        /* Conteneur spécifique pour les médias et les placeholders */
        .media-area {
            flex-grow: 1; /* Prend l'espace maximal disponible */
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Prévient le débordement */
            padding-bottom: 0.5rem; /* Espace avant la légende */
        }
        
        .cover-page {
            background-color: #f7f7f7;
            border: none;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        
        /* Style spécifique pour le placeholder de fichier manquant */
        .local-file-placeholder {
            @apply flex justify-center items-center w-full h-full text-white font-bold text-center p-4 rounded-lg flex-col;
            background-color: #ef4444; /* Rouge Tailwind 500 */
            border: 2px dashed #b91c1c; /* Rouge Tailwind 700 */
            max-height: 100%;
            overflow: hidden;
        }
        
        /* Style des images */
        .media-image {
            /* Changé de cover à contain pour que l'image ne soit jamais coupée */
            object-fit: contain; 
            width: auto; 
            max-width: 100%;
            max-height: 100%; /* Contrainte de hauteur stricte */
            height: auto; 
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4">

    <!-- Bouton pour basculer entre le mode Lecture et Admin -->
    <div class="fixed top-4 right-4 z-50">
        <button id="toggleAdminBtn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-full shadow-lg transition duration-200">
            Passer en mode Admin
        </button>
    </div>

    <!-- Conteneur principal (Lecture) -->
    <div id="viewerMode" class="max-w-7xl mx-auto py-8 transition-opacity duration-500">
        <h1 class="text-4xl font-extrabold text-center text-green-700 mb-4">
            Mon Album Souvenirs Géré par Firestore
        </h1>
        
        <!-- Alerte pour les fichiers locaux non chargés -->
        <div class="max-w-xl mx-auto p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg text-center mb-6">
            <p class="font-bold">⚠️ ATTENTION AUX CHEMINS LOCAUX</p>
            <p class="text-sm">Si vous voyez des cadres rouges, vous devez utiliser une **URL Publique** (via Firebase Hosting par exemple) pour un affichage sur mobile.</p>
        </div>

        <!-- Status de Connexion et Débogage -->
        <div id="statusArea" class="max-w-xl mx-auto p-4 bg-blue-100 border border-blue-400 text-blue-700 rounded-lg text-center mb-6">
            <p id="authStatus" class="font-bold">Authentification Firebase : En cours...</p>
            <p id="dbStatus" class="text-sm">Connexion Firestore : En cours...</p>
        </div>

        <div class="flip-book-container">
            <div id="monAlbum" class="rounded-lg shadow-2xl">
                <!-- Les pages seront injectées ici par JavaScript -->
            </div>
        </div>
        
        <div class="navigation-buttons flex justify-center space-x-4 mt-8">
            <button id="prevBtn" class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-full shadow-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                ← Précédent
            </button>
            <button id="nextBtn" class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-full shadow-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                Suivant →
            </button>
        </div>
    </div>

    <!-- Panneau Administrateur (Initialement caché) -->
    <div id="adminMode" class="max-w-4xl mx-auto py-8 hidden transition-opacity duration-500">
        <h1 class="text-4xl font-extrabold text-center text-indigo-700 mb-8">
            Panneau d'Administration (Firestore)
        </h1>

        <!-- Formulaire d'Ajout/Édition -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 id="formTitle" class="text-2xl font-semibold text-gray-800 mb-4">Ajouter une Nouvelle Page</h2>
            <form id="pageForm" class="space-y-4">
                <input type="hidden" id="pageId">
                <input type="hidden" id="pageIndex">
                
                <label class="block">
                    <span class="text-gray-700">Type de Contenu (layout) :</span>
                    <select id="pageLayout" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        <option value="text-only">Texte Seul</option>
                        <option value="portrait">Image Portrait (1)</option>
                        <option value="portrait-pair">Images Portrait (2)</option>
                        <option value="landscape-only">Image Paysage (1)</option>
                        <option value="cover">Couverture</option>
                        <option value="video-simulated">Vidéo (Chemin Local)</option> 
                    </select>
                </label>
                
                <label class="block">
                    <span class="text-gray-700">Chemin du Fichier Média (URL Local ou Public - ex: images/mon_image.webp) :</span>
                    <input type="text" id="pageMediaUrl" list="mediaPaths" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Saisir un chemin local ou un URL public">
                    
                    <!-- DATALIST POUR L'AUTOCOMPLÉTION DES CHEMINS -->
                    <datalist id="mediaPaths">
                        <!-- Les options sont remplies par JavaScript -->
                    </datalist>
                </label>
                
                <label class="block">
                    <span class="text-gray-700">Titre/Légende :</span>
                    <input type="text" id="pageCaption" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Titre pour la couverture, légende pour l'image">
                </label>

                <label class="block">
                    <span class="text-gray-700">Contenu Textuel (pour layout "Texte Seul") :</span>
                    <textarea id="pageText" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Contenu HTML ou texte simple"></textarea>
                </label>
                
                <div class="flex space-x-4">
                    <button type="submit" class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-lg shadow transition duration-200">
                        Sauvegarder la Page
                    </button>
                    <button type="button" id="cancelEditBtn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg shadow transition duration-200 hidden">
                        Annuler
                    </button>
                </div>
            </form>
        </div>

        <!-- Liste des Pages Existantes -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Pages Actuelles de l'Album</h2>
            <ul id="pagesList" class="space-y-3">
                <!-- Les pages seront injectées ici -->
                <li class="text-center text-gray-500">Chargement des pages...</li>
            </ul>
        </div>
        
        <!-- Affichage de l'ID Utilisateur (Débogage) -->
        <div class="mt-6 text-center text-sm text-gray-500">
            ID Utilisateur (pour Firestore): <span id="currentUserId" class="font-mono text-gray-700 break-all">Chargement...</span>
        </div>
    </div>

    <!-- Script de l'Application -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, setDoc, addDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Globales Firestore MANDATOIRES
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-album-app';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        const ALBUM_COLLECTION_PATH = `artifacts/${appId}/public/data/album_pages`;
        let currentAlbumData = [];
        let isTurnInitialized = false; 
        const PAGE_ASPECT_RATIO = 4/3; 
        
        // Fonction utilitaire pour mettre à jour le panneau de statut
        function updateStatus(authMsg, dbMsg) {
            if (authMsg) {
                document.getElementById('authStatus').textContent = authMsg;
            }
            if (dbMsg) {
                document.getElementById('dbStatus').textContent = dbMsg;
            }
        }


        // --- 1. INITIALISATION FIREBASE & AUTHENTIFICATION ---

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
                document.getElementById('currentUserId').textContent = userId;
                
                updateStatus(`Authentification Firebase : Réussie (User: ${userId.substring(0, 8)}...)`, null);
                console.log("Firebase initialisé. User ID:", userId);
                
                // Démarrer l'écoute des données après l'authentification
                listenForAlbumData();

            } catch (error) {
                updateStatus("Authentification Firebase : ÉCHEC", `Erreur: ${error.code} ou Réseau coupé.`);
                console.error("Erreur d'initialisation Firebase:", error);
            }
        }

        // --- 2. GESTION DES DONNÉES DE L'ALBUM (CRUD) ---
        
        // Données initiales si la collection est vide
        const INITIAL_ALBUM_DATA = [
            { type: 'cover', layout: 'cover', title: 'Six mois en Calédonie', subtitle: 'Un voyage inoubliable', media: [], text: null, index: 1 }, 
            { type: 'content', layout: 'text-only', text: `<p class="mb-4">"Le vrai voyage de découverte ne consiste pas à chercher de nouveaux paysages, mais à avoir de nouveaux yeux."</p><p class="font-semibold text-green-600 mb-6"> - Marcel Proust</p><p class="text-base text-gray-500 italic">Ces six mois m'ont non seulement montré le monde, mais ils m'ont transformé.</p>`, media: [], index: 2 }, 
            { type: 'content', layout: 'text-only', text: `<p class="mb-4 text-2xl font-bold text-gray-800">Un voyage en Nouvelle Calédonie, ça demande de la patience, ça prend approximativement de 25h à 7 jours.</p>`, media: [], index: 3 }, 
            { type: 'content', layout: 'portrait-pair', text: null, media: [ { url: 'images/sac.webp', caption: 'Le départ (Fichier Local)' }, { url: 'images/sac1.webp', caption: 'Soleil en face ! (Fichier Local)' } ], index: 4 }, 
            { type: 'content', layout: 'video-simulated', text: null, media: [ { url: 'videos/VID_20250516_072230.mp4', caption: 'Arrivée magique (Fichier Local)' } ], index: 5 }, 
            { type: 'content', layout: 'portrait', text: null, media: [ { url: 'images/bananes.webp', caption: 'Le petit paradis, vue du jardin. (Fichier Local)' } ], index: 6 }, 
            { type: 'content', layout: 'landscape-only', text: null, media: [ { url: 'images/jardin.webp', caption: 'Petit lever de soleil sur le jardin. (Fichier Local)' } ], index: 7 }, 
            { type: 'content', layout: 'text-only', text: `<p class="mb-4 text-3xl font-extrabold text-green-700">Nouméa, la capitale</p>`, media: [], index: 8 }, 
            { type: 'content', layout: 'portrait', text: null, media: [ { url: 'images/noumea.webp', caption: 'L\'Anse Vata (Fichier Local)' } ], index: 9 },
            { type: 'content', layout: 'cover', title: 'Bye la Province Sud', subtitle: 'To be continued...', media: [], text: null, index: 10 }
        ];
        
        // URLs publiques qui seront toujours proposées en autocomplétion
        const PUBLIC_PLACEHOLDER_URLS = [
            'https://placehold.co/400x550/008080/ffffff?text=PAYSAGE+WEB',
            'https://placehold.co/300x450/4CAF50/ffffff?text=PORTRAIT+WEB+1',
            'https://placehold.co/300x450/2196F3/ffffff?text=PORTRAIT+WEB+2',
            'https://placehold.co/600x400/FF5722/ffffff?text=COUVERTURE+WEB',
            // Ajout des chemins locaux par défaut pour l'autocomplétion
            'images/sac.webp',
            'images/sac1.webp',
            'videos/VID_20250516_072230.mp4',
            'images/bananes.webp',
            'images/jardin.webp',
            'images/noumea.webp',
        ];

        // Fonction pour mettre à jour la liste d'autocomplétion 
        function updateDatalist(pages) {
            const mediaPaths = new Set(PUBLIC_PLACEHOLDER_URLS);
            
            pages.forEach(page => {
                if (page.media && Array.isArray(page.media)) {
                    page.media.forEach(media => {
                        if (media.url) {
                            mediaPaths.add(media.url);
                        }
                    });
                }
            });

            const datalist = document.getElementById('mediaPaths');
            
            if (!datalist) {
                console.error("Erreur: L'élément datalist (#mediaPaths) n'a pas été trouvé.");
                return;
            }

            datalist.innerHTML = ''; 
            
            mediaPaths.forEach(path => {
                const option = document.createElement('option');
                option.value = path;
                datalist.appendChild(option);
            });
            console.log("Datalist d'autocomplétion mise à jour avec", mediaPaths.size, "chemins/URLs.");
        }


        // Charger et écouter les données en temps réel
        async function listenForAlbumData() {
            const albumCollection = collection(db, ALBUM_COLLECTION_PATH);
            const q = query(albumCollection, orderBy("index"));

            const snapshot = await getDocs(albumCollection);
            if (snapshot.empty) {
                console.log("Collection vide, peuplement initial...");
                // Utilisation de Promise.all pour un ajout plus rapide
                const batch = INITIAL_ALBUM_DATA.map((data, i) => 
                    addDoc(albumCollection, { ...data, index: i + 1, createdAt: new Date().toISOString() })
                );
                await Promise.all(batch);
            }

            onSnapshot(q, (snapshot) => {
                const pages = [];
                snapshot.forEach(doc => {
                    pages.push({ id: doc.id, ...doc.data() });
                });
                
                // Assurer que les indexes sont séquentiels et à jour pour le déplacement
                currentAlbumData = pages.map((p, i) => ({ ...p, index: i + 1 }));

                renderAdminList(currentAlbumData);
                renderAlbum(currentAlbumData);
                updateDatalist(currentAlbumData); 
                updateStatus(null, `Connexion Firestore : Active (${currentAlbumData.length} pages chargées)`);

            }, (error) => {
                updateStatus(null, `Connexion Firestore : ÉCHEC (Vérifiez les règles de sécurité)`);
                console.error("Erreur onSnapshot:", error);
            });
        }
        
        // Sauvegarder (Ajouter ou Mettre à jour) une page
        async function savePage(id, data, currentIdx) {
            const albumCollection = collection(db, ALBUM_COLLECTION_PATH);
            const dataToSave = {
                ...data,
                index: id ? currentIdx : (currentAlbumData.length + 1),
                createdAt: data.createdAt || new Date().toISOString()
            };

            try {
                if (id) {
                    await updateDoc(doc(db, ALBUM_COLLECTION_PATH, id), dataToSave);
                    console.log("Page mise à jour avec succès:", id);
                } else {
                    await addDoc(albumCollection, dataToSave);
                    console.log("Nouvelle page ajoutée avec succès.");
                }

            } catch (e) {
                console.error("Erreur lors de la sauvegarde de la page:", e);
            }
        }

        // Supprimer une page
        async function deletePage(id) {
            // Remplacer confirm() par une alerte/confirmation customisée (meilleure pratique)
            if (!id) return;
            if (!window.confirm('Êtes-vous sûr de vouloir supprimer cette page ? (Utiliser un modal customisé est recommandé)')) return;


            try {
                await deleteDoc(doc(db, ALBUM_COLLECTION_PATH, id));
                console.log("Page supprimée avec succès:", id);
                
            } catch (e) {
                console.error("Erreur lors de la suppression:", e);
            }
        }
        
        // --- 3. RENDU DE L'ALBUM (TURN.JS) ---

        function createPageElement(data, index) {
            let contentHTML = '';
            const isCover = data.layout === 'cover';
            const pageNumber = index + 1;
            
            // Fonction utilitaire pour créer la balise d'image avec fallback
            function renderMedia(url, caption) {
                // Utilisation de JSON.stringify pour échapper correctement les chaînes dans le JS embarqué
                const placeholder = `<div class="local-file-placeholder h-full text-lg bg-red-600">FICHIER LOCAL NON CHARGÉ : ${url}<p class="text-sm mt-2 font-normal">Page ${pageNumber}</p></div>`;
                
                // Si l'URL n'est pas un chemin public (ne commence pas par http)
                if (!url || !url.startsWith('http')) {
                    // Pour le cas local, nous insérons une image avec un gestionnaire d'erreur pour capturer le cas "file:// access denied"
                    // et un fallback simple.
                    return `
                        <img src="${url}" alt="${caption}" class="media-image" 
                            onerror="this.outerHTML = '${placeholder}'" 
                            onload="if(this.naturalWidth === 0) { this.outerHTML = '${placeholder}'; }">
                    `;
                } else {
                    // URL publique, l'affichage direct est plus fiable ici
                    return `
                        <img src="${url}" alt="${caption}" class="media-image" 
                            onerror="this.outerHTML = '${placeholder}'">
                    `;
                }
            }


            if (isCover) {
                const title = data.title || 'Couverture';
                const subtitle = data.subtitle || '';
                contentHTML = `
                    <div class="cover-page flex flex-col justify-center items-center w-full h-full p-8 text-white bg-green-800 rounded-lg">
                        <h2 class="w-full text-4xl md:text-6xl font-extrabold text-center">${title}</h2>
                        <p class="w-full text-xl md:text-2xl mt-6 font-light text-center">${subtitle}</p>
                        <p class="absolute bottom-4 right-4 text-sm font-light opacity-70">Page ${pageNumber}</p>
                    </div>
                `;
            } else {
                
                if (data.layout === 'portrait' || data.layout === 'landscape-only' || data.layout === 'video-simulated') {
                    const media = data.media && data.media[0] ? data.media[0] : { url: '', caption: 'Aucun média' };
                    const mediaContent = media.url ? renderMedia(media.url, media.caption) : renderMedia('Image/Vidéo attendue', '');

                    contentHTML = `
                        <div class="content-page-wrapper">
                            <div class="media-area">
                                ${mediaContent}
                            </div>
                            <p class="text-sm text-gray-600 flex-none">${media.caption || ''}</p>
                            <p class="text-xs text-gray-400 flex-none">Page ${pageNumber}</p>
                        </div>
                    `;

                } else if (data.layout === 'portrait-pair') {
                    contentHTML = `
                        <div class="content-page-wrapper p-2">
                            <div class="flex w-full h-full justify-around items-center space-x-4 media-area">
                                ${data.media.map((media, i) => `
                                    <div class="flex flex-col w-1/2 h-full items-center justify-start p-1">
                                        <div class="w-full h-full flex-grow flex justify-center items-center overflow-hidden">
                                            ${renderMedia(media.url || '', media.caption)}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                             <p class="text-xs text-gray-600 mt-2 flex-none text-center w-full">${data.media[0]?.caption || ''}</p>
                            <p class="text-xs text-gray-400 flex-none">Page ${pageNumber}</p>
                        </div>
                    `;
                    
                } else if (data.layout === 'text-only') {
                    contentHTML = `
                        <div class="content-page-wrapper justify-center bg-gray-50/70 rounded-lg p-8">
                            <div class="max-w-md mx-auto text-xl md:text-2xl font-serif text-gray-800 leading-relaxed text-center flex-grow flex flex-col justify-center">
                                ${data.text}
                            </div>
                            <p class="text-xs text-gray-400 flex-none">Page ${pageNumber}</p>
                        </div>
                    `;
                }
            }
            
            const pageElement = $('<div></div>').addClass('page').attr('id', `page-${pageNumber}`).html(contentHTML);
            
            if (isCover) {
                pageElement.addClass('cover-page').removeClass('page');
            }

            return pageElement[0].outerHTML;
        }

        function renderAlbum(data) {
            const $album = $('#monAlbum');
            
            if (isTurnInitialized) {
                $album.turn('destroy');
                isTurnInitialized = false;
            }
            
            $album.empty();

            data.forEach((page, index) => {
                $album.append(createPageElement(page, index));
            });
            
            resizeAlbum(data.length);
        }
        
        function resizeAlbum(totalPages) {
            const $album = $('#monAlbum');
            const container = $('.flip-book-container')[0];
            const maxContainerWidth = container.clientWidth;
            const maxContainerHeight = window.innerHeight * 0.8;
            
            const isSinglePageMode = maxContainerWidth < maxContainerHeight * PAGE_ASPECT_RATIO * 1.5; 
            
            let finalWidth, finalHeight;
            
            if (isSinglePageMode) {
                finalHeight = Math.min(maxContainerHeight * 0.95, 600); 
                finalWidth = finalHeight / PAGE_ASPECT_RATIO;
                if (finalWidth > maxContainerWidth * 0.95) {
                    finalWidth = maxContainerWidth * 0.95;
                    finalHeight = finalWidth * PAGE_ASPECT_RATIO;
                }
            } else {
                finalHeight = Math.min(maxContainerHeight * 0.95, 600); 
                finalWidth = finalHeight * PAGE_ASPECT_RATIO * 2;
                if (finalWidth > maxContainerWidth * 0.95) {
                    finalWidth = maxContainerWidth * 0.95;
                    finalHeight = finalWidth / (PAGE_ASPECT_RATIO * 2);
                }
            }

            finalWidth = Math.round(finalWidth);
            finalHeight = Math.round(finalHeight);

            if (!isTurnInitialized) {
                $album.turn({
                    width: finalWidth,         
                    height: finalHeight,        
                    autoCenter: true,   
                    display: isSinglePageMode ? 'single' : 'double',  
                    elevation: 50,      
                    gradients: true,    
                    duration: 2000,
                    pages: totalPages 
                });
                
                isTurnInitialized = true;
                $album.css('visibility', 'visible');
                
                $album.on('turning', function(event, page, view) { updateNavigation(page, totalPages); });
                $('#prevBtn').on('click', function() { $album.turn('previous'); });
                $('#nextBtn').on('click', function() { $album.turn('next'); });
                
            } else {
                $album.turn('size', finalWidth, finalHeight);
                $album.turn('display', isSinglePageMode ? 'single' : 'double');
                $album.turn('center');
                $album.turn('pages', totalPages);
            }
            updateNavigation($album.turn('page') || 1, totalPages);
        }
        
        function updateNavigation(page, totalPages) {
            $('#prevBtn').prop('disabled', page <= 1); 
            $('#nextBtn').prop('disabled', page >= totalPages);
        }

        // --- 4. GESTION DU PANNEAU ADMIN ---

        function renderAdminList(pages) {
            const $list = $('#pagesList');
            $list.empty();
            if (pages.length === 0) {
                $list.html('<li class="text-center text-gray-500 italic">Aucune page dans l\'album. Ajoutez-en une !</li>');
                return;
            }

            pages.forEach(page => {
                const title = page.layout === 'cover' ? `Couverture: ${page.title}` : 
                              page.layout === 'text-only' ? `Texte Seul` :
                              `Média: ${page.media?.[0]?.url || page.layout}`;

                const listItem = $(`
                    <li class="flex justify-between items-center p-3 bg-gray-50 border border-gray-200 rounded-lg shadow-sm">
                        <span class="text-sm font-medium text-gray-700">
                            Page ${page.index}: ${title}
                        </span>
                        <div class="space-x-2">
                            <button data-id="${page.id}" data-index="${page.index}" class="edit-btn text-indigo-600 hover:text-indigo-800 transition duration-150">Éditer</button>
                            <button data-id="${page.id}" class="delete-btn text-red-600 hover:text-red-800 transition duration-150">Supprimer</button>
                            <button data-id="${page.id}" data-index="${page.index}" data-dir="-1" class="move-up-btn text-gray-600 hover:text-gray-800 transition duration-150" title="Déplacer vers le haut">▲</button>
                            <button data-id="${page.id}" data-index="${page.index}" data-dir="1" class="move-down-btn text-gray-600 hover:text-gray-800 transition duration-150" title="Déplacer vers le bas">▼</button>
                        </div>
                    </li>
                `);
                $list.append(listItem);
            });
            
            $('.edit-btn').on('click', function() { loadPageForEdit($(this).data('id')); });
            $('.delete-btn').on('click', function() { deletePage($(this).data('id')); });
            $('.move-up-btn, .move-down-btn').on('click', handleMovePage);
        }

        function loadPageForEdit(id) {
            const page = currentAlbumData.find(p => p.id === id);
            if (!page) return;

            $('#pageId').val(page.id);
            $('#pageIndex').val(page.index);
            $('#pageLayout').val(page.layout);
            
            const mediaUrl = page.media && page.media[0] ? page.media[0].url : '';
            const caption = page.media && page.media[0] ? page.media[0].caption : (page.subtitle || page.title || '');

            // Si c'est un layout portrait-pair, on vérifie s'il y a une deuxième URL à ajouter pour l'édition
            if (page.layout === 'portrait-pair' && page.media && page.media.length > 1) {
                 $('#pageMediaUrl').val(page.media.map(m => m.url).join(', '));
            } else {
                 $('#pageMediaUrl').val(mediaUrl);
            }
           
            $('#pageCaption').val(caption);
            $('#pageText').val(page.text || '');

            $('#formTitle').text(`Éditer la Page ${page.index}`);
            $('#cancelEditBtn').removeClass('hidden');
            document.getElementById('adminMode').scrollIntoView({ behavior: 'smooth' });
        }

        function resetForm() {
            $('#pageForm')[0].reset();
            $('#pageId').val('');
            $('#pageIndex').val('');
            $('#formTitle').text('Ajouter une Nouvelle Page');
            $('#cancelEditBtn').addClass('hidden');
        }

        async function handleMovePage() {
            const $btn = $(this);
            const id = $btn.data('id');
            const currentIdx = $btn.data('index');
            const direction = parseInt($btn.data('dir')); 
            const newIdx = currentIdx + direction;
            
            const targetPage = currentAlbumData.find(p => p.index === newIdx);
            const currentPage = currentAlbumData.find(p => p.id === id);

            if (!targetPage || !currentPage) return;

            try {
                // Échange des index pour un déplacement simple
                await updateDoc(doc(db, ALBUM_COLLECTION_PATH, currentPage.id), { index: newIdx });
                await updateDoc(doc(db, ALBUM_COLLECTION_PATH, targetPage.id), { index: currentIdx });
                console.log(`Page ${currentPage.id} déplacée de ${currentIdx} à ${newIdx}.`);
            } catch (e) {
                console.error("Erreur lors du déplacement de la page:", e);
            }
        }
        
        function toggleAdminMode() {
            const viewer = $('#viewerMode');
            const admin = $('#adminMode');
            const btn = $('#toggleAdminBtn');
            
            if (admin.hasClass('hidden')) {
                viewer.addClass('hidden');
                admin.removeClass('hidden');
                btn.removeClass('bg-indigo-600').addClass('bg-pink-600').text('Passer en mode Lecture');
            } else {
                admin.addClass('hidden');
                viewer.removeClass('hidden');
                btn.removeClass('bg-pink-600').addClass('bg-indigo-600').text('Passer en mode Admin');
                // Redimensionner l'album lorsqu'on revient au mode Lecture
                if (isTurnInitialized) { 
                    resizeAlbum(currentAlbumData.length); 
                }
            }
        }

        // --- 5. GESTIONNAIRES D'ÉVÉNEMENTS PRINCIPAUX ---
        
        $('#pageForm').on('submit', async function(e) {
            e.preventDefault();
            
            const id = $('#pageId').val();
            const currentIdx = parseInt($('#pageIndex').val());
            const layout = $('#pageLayout').val();
            const mediaUrlInput = $('#pageMediaUrl').val().trim();
            const caption = $('#pageCaption').val().trim();
            const text = $('#pageText').val().trim();

            let data;
            
            if (layout === 'cover') {
                data = {
                    type: 'cover',
                    layout: 'cover',
                    title: caption, // Le titre de la couverture est dans la légende
                    subtitle: text || 'Sous-titre',
                    media: [],
                    text: null
                };
            } else if (layout === 'text-only') {
                data = {
                    type: 'content',
                    layout: 'text-only',
                    title: null,
                    subtitle: null,
                    media: [],
                    text: text
                };
            } else {
                const mediaItems = [];
                
                // Gestion des paires d'images (séparées par des virgules)
                if (layout === 'portrait-pair') {
                    const urls = mediaUrlInput.split(',').map(url => url.trim()).filter(url => url !== '');
                    if (urls.length > 0) {
                        // Utilise l'URL 1 et l'URL 2 si elles existent
                        mediaItems.push({ url: urls[0], caption: caption });
                        if (urls.length > 1) {
                            mediaItems.push({ url: urls[1], caption: caption });
                        } else {
                            // Si une seule URL est fournie, on la duplique (ou on peut mettre un placeholder)
                            mediaItems.push({ url: urls[0], caption: caption }); 
                        }
                    } else {
                        // Pas d'URL fournie, ajouter un placeholder vide
                        mediaItems.push({ url: '', caption: caption });
                        mediaItems.push({ url: '', caption: caption });
                    }
                } else if (mediaUrlInput) {
                    // Pour les autres layouts (portrait, landscape, video)
                    mediaItems.push({ url: mediaUrlInput, caption: caption });
                }

                data = {
                    type: 'content',
                    layout: layout,
                    title: null,
                    subtitle: null,
                    media: mediaItems,
                    text: null
                };
            }
            
            await savePage(id, data, currentIdx);
            resetForm();
        });

        $('#cancelEditBtn').on('click', resetForm);
        $('#toggleAdminBtn').on('click', toggleAdminMode);

        $(window).resize(function() {
            clearTimeout(window.resizeTimeout);
            window.resizeTimeout = setTimeout(() => {
                if ($('#viewerMode').is(':visible') && isTurnInitialized) {
                    resizeAlbum(currentAlbumData.length);
                }
            }, 100);
        });

        // --- Démarrage de l'application ---
        $(document).ready(initFirebase);

    </script>
</body>
</html>
